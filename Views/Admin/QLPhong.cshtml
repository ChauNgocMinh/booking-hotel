@model LoaiPhongAndPhong
@{
    Layout = "_AdminLayout";
}

<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Quản lý phòng & Loại phòng</h3>

        <div class="d-flex gap-2">
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalAddLoai">
                <i class="bi bi-plus-lg"></i> Thêm loại phòng
            </button>

            <button type="button"
                    class="btn btn-danger"
                    data-bs-toggle="modal"
                    data-bs-target="#modalPhong"
                    data-mode="add">
                <i class="bi bi-hotel"></i> Thêm phòng
            </button>

        </div>
    </div>

    <div class="row g-3">
        <!-- LEFT: Loại phòng (scrollable) -->
        <aside class="col-12 col-md-3">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Loại phòng</strong>
                    <a class="btn btn-sm btn-outline-secondary" href="/admin/QLPhong/">All</a>
                </div>

                <div class="list-group list-group-flush overflow-auto" style="max-height:70vh;">
                    @foreach (LoaiPhong p in Model.lp)
                    {
                        <a class="list-group-item list-group-item-action" href="/admin/QLPhong/@p.MaLoaiPhong">
                            <div class="d-flex justify-content-between">
                                <div>@p.TenLoaiPhong</div>
                            </div>
                            <small class="text-muted">Mã: @p.MaLoaiPhong</small>
                        </a>
                    }
                </div>
            </div>
        </aside>

        <!-- RIGHT: Danh sách phòng & các bảng -->
        <section class="col-12 col-md-9">
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height:72vh; overflow:auto;">
                        <table class="table table-striped table-hover mb-0 align-middle">
                            <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                                <tr>
                                    <th>Mã phòng</th>
                                    <th>Ảnh</th>
                                    <th>Tên phòng</th>
                                    <th>Mô tả</th>
                                    <th>Giá</th>

                                    <th class="text-center">Hành động</th>
                                </tr>
                            </thead>

                            <tbody>
                                @foreach (var p in Model.p)
                                {
                                    <tr>
                                        <td>@p.MaPhong</td>

                                        <td class="text-center">
                                            @if (!string.IsNullOrEmpty(p.Anh))
                                            {
                                                <img src="@p.Anh" class="img-thumbnail"
                                                     style="width:100px;height:70px;object-fit:cover;">
                                            }
                                        </td>

                                        <td>@p.TenPhong</td>

                                        <td>
                                            <textarea class="form-control form-control-sm" rows="2" readonly>
@p.MoTaPhong
            </textarea>
                                        </td>

                                        <td>@String.Format("{0:N0}", p.Gia)</td>

                                        <td class="text-center">
                                            <button class="btn btn-sm btn-primary"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modalPhong"
                                                    data-mode="edit"
                                                    data-maphong="@p.MaPhong"
                                                    data-makhachsan="@p.MaKhachSan"
                                                    data-tenphong="@p.TenPhong"
                                                    data-maloaiphong="@p.MaLoaiPhong"
                                                    data-gia="@p.Gia"
                                                    data-matrangthai="@p.MaTrangThai"
                                                    data-anh="@p.Anh"
                                                    data-motaphong="@p.MoTaPhong">
                                                ✏️ Sửa
                                            </button>

                                            <button class="btn btn-sm btn-outline-danger"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modalConfirmDelete"
                                                    data-maphong="@p.MaPhong">
                                                🗑 Xóa
                                            </button>

                                        </td>
                                    </tr>
                                }
                            </tbody>

                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<div class="modal fade" id="modalPhong" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <form method="post" id="formPhong" class="needs-validation" novalidate enctype="multipart/form-data">

                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="makhachsan" id="makhachsan">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label>Mã phòng</label>
                            <input class="form-control" name="maphong" id="maphong" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label>Tên phòng</label>
                            <input class="form-control" name="tenphong" id="tenphong" required>
                        </div>

                        <div class="col-md-6">
                            <label>Loại phòng</label>
                            <select class="form-select" name="maloaiphong" id="maloaiphong" required>
                                @foreach (var lp in Model.lp)
                                {
                                    <option value="@lp.MaLoaiPhong">@lp.TenLoaiPhong</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label>Giá</label>
                            <input type="number" class="form-control" name="gia" id="gia" required>
                        </div>

                        <div class="col-md-6">
                            <label>Trạng thái</label>
                            <select class="form-select" name="matrangthai" id="matrangthai">
                                <option value="TRONG">Trống</option>
                                <option value="DADAT">Đã đặt</option>
                            </select>
                        </div>

                        <input type="hidden" name="anhCu" id="anhCu">

                        <div class="col-12">
                            <label>Ảnh</label>
                            <input class="form-control" type="file"
                                   name="imageFile"
                                   id="imageFile"
                                   accept="image/*">
                        </div>

                        <div class="col-12">
                            <img id="previewImg"
                                 style="max-width:150px;display:none"
                                 class="img-thumbnail mt-2" />
                        </div>

                        <div class="col-12">
                            <label>Mô tả</label>
                            <textarea class="form-control" name="motaphong" id="motaphong"></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-danger" id="btnSubmit"></button>
                </div>

            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalConfirmDelete" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title text-danger">⚠️ Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <p>
                    Bạn có chắc chắn muốn xóa phòng
                    <strong id="deleteMaPhong"></strong> không?
                </p>
                <p class="text-muted mb-0">Hành động này không thể hoàn tác.</p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Hủy
                </button>
                <a href="#" class="btn btn-danger" id="btnConfirmDelete">
                    🗑 Xóa
                </a>
            </div>

        </div>
    </div>
</div>

<!-- Modal Thêm Loại phòng -->
<div class="modal fade" id="modalAddLoai" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" asp-controller="Admin" asp-action="themLoaiPhong" class="needs-validation" novalidate>
                <div class="modal-header">
                    <h5 class="modal-title">Thêm loại phòng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Mã loại phòng</label>
                        <input class="form-control" name="maloaiphong" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tên loại phòng</label>
                        <input class="form-control" name="tenloaiphong" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Giá loại phòng</label>
                        <input class="form-control" name="gialoaiphong" type="number" min="0" required />
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-danger">Thêm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Optional: Bootstrap icons CDN (dùng icon nhỏ) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<!-- Client-side: bootstrap validation + auto-resize textareas -->
<script>
    (function () {
        'use strict'
        // Bootstrap form validation
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })

        // Auto-resize readonly textareas (table description)
        document.querySelectorAll('textarea[readonly]').forEach(t => {
            t.style.height = t.scrollHeight + 'px';
            t.style.resize = 'none';
        });
    })();
</script>
<script>
    document.getElementById('modalPhong').addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const mode = button.getAttribute('data-mode');

        const form = document.getElementById('formPhong');
        const title = document.getElementById('modalTitle');
        const submit = document.getElementById('btnSubmit');

        if (mode === 'add') {
            title.innerText = '➕ Thêm phòng mới';
            submit.innerText = 'Thêm phòng';
            form.action = '/Admin/themPhong';

            form.reset();
            document.getElementById('maphong').value = '';
            document.getElementById('makhachsan').value = '';

        } else {
            title.innerText = '✏️ Sửa phòng';
            submit.innerText = 'Lưu thay đổi';
            form.action = '/Admin/suaPhong';

            document.getElementById('maphong').value = button.dataset.maphong;
            document.getElementById('makhachsan').value = button.dataset.makhachsan;
            document.getElementById('tenphong').value = button.dataset.tenphong;
            document.getElementById('maloaiphong').value = button.dataset.maloaiphong;
            document.getElementById('gia').value = button.dataset.gia;
            document.getElementById('matrangthai').value = button.dataset.matrangthai;
            document.getElementById('anh').value = button.dataset.anh;
            document.getElementById('motaphong').value = button.dataset.motaphong;
        }
    });

      document.getElementById('modalConfirmDelete')
        .addEventListener('show.bs.modal', function (event) {

            const button = event.relatedTarget;
            const maPhong = button.getAttribute('data-maphong');

            document.getElementById('deleteMaPhong').innerText = maPhong;
            document.getElementById('btnConfirmDelete').href =
                '/Admin/phong/xoaPhong/' + maPhong;
        });

            document.getElementById('imageFile').addEventListener('change', e => {
        const img = document.getElementById('previewImg');
        if (e.target.files.length > 0) {
            img.src = URL.createObjectURL(e.target.files[0]);
            img.style.display = 'block';
        }
    });

    document.getElementById('modalPhong')
        .addEventListener('show.bs.modal', function (event) {

        const btn = event.relatedTarget;
        const mode = btn.dataset.mode;

        if (mode === 'edit') {
            const anh = btn.dataset.anh;
            document.getElementById('anhCu').value = anh;

            if (anh) {
                const img = document.getElementById('previewImg');
                img.src = anh;
                img.style.display = 'block';
            }
        } else {
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('anhCu').value = '';
        }
    });
</script>
