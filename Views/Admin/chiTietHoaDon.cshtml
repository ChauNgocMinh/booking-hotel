@model HoaDon
@{
    Layout = "_AdminLayout";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Chi tiết hóa đơn</h3>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary btn-sm" asp-controller="Admin" asp-action="QLHoaDon"><i class="bi bi-arrow-left"></i> Quay lại</a>
        </div>
    </div>

    <div id="invoiceCard" class="card">
        <div class="card-body">
            @* Header: phòng + giá *@
            @{
                // defensive null checks
                var order = Model?.MaOrderPhongNavigation;
                var phong = order?.MaPhongNavigation;
                var loaiphong = phong?.MaLoaiPhongNavigation;
                decimal giaPhong = phong != null ? Convert.ToDecimal(phong.Gia) : 0m;
                string tenPhong = phong?.TenPhong ?? "—";
                DateTime? ngayDen = order?.NgayDen != null ? (DateTime?)Convert.ToDateTime(order.NgayDen) : null;
                DateTime? ngayDi = order?.NgayDi != null ? (DateTime?)Convert.ToDateTime(order.NgayDi) : null;
                int totalDays = 0;
                if (ngayDen.HasValue && ngayDi.HasValue) totalDays = Convert.ToInt32((ngayDi.Value - ngayDen.Value).TotalDays);
                decimal tongTienPhong = totalDays * giaPhong;
            }

            <div class="row mb-3">
                <div class="col-md-8">
                    <h4 class="mb-1">@tenPhong <small class="text-muted">- @String.Format("{0:N0}", giaPhong)</small></h4>
                    <div class="small text-muted">Mã hóa đơn: <strong>@Model?.MaHoaDon</strong></div>
                    <div class="small text-muted">Mã order: <strong>@order?.MaOrderPhong</strong></div>
                </div>

                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <span class="badge bg-info text-dark">Ngày lập: @((Model?.NgayIn is DateTime nl) ? nl.ToString("dd/MM/yyyy HH:mm") : "")</span>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card border-secondary">
                        <div class="card-body">
                            <h6>Thông tin khách</h6>
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Họ và tên</dt>
                                <dd class="col-sm-8">@order?.Person?.HoTen</dd>

                                <dt class="col-sm-4">Tuổi</dt>
                                <dd class="col-sm-8">@order?.Person?.Tuoi</dd>

                                <dt class="col-sm-4">Giới tính</dt>
                                <dd class="col-sm-8">@((order?.Person?.GioiTinh == 0) ? "Nam" : "Nữ")</dd>

                                <dt class="col-sm-4">CCCD</dt>
                                <dd class="col-sm-8">@order?.Person?.PersonId</dd>

                                <dt class="col-sm-4">SĐT</dt>
                                <dd class="col-sm-8">@order?.Person?.Sdt</dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card border-secondary">
                        <div class="card-body">
                            <h6>Thông tin đặt phòng</h6>
                            <dl class="row mb-0">
                                <dt class="col-sm-6">Ngày đến</dt>
                                <dd class="col-sm-6">@ngayDen?.ToString("dd/MM/yyyy")</dd>

                                <dt class="col-sm-6">Ngày đi</dt>
                                <dd class="col-sm-6">@ngayDi?.ToString("dd/MM/yyyy")</dd>

                                <dt class="col-sm-6">Số ngày ở</dt>
                                <dd class="col-sm-6">@totalDays</dd>

                                <dt class="col-sm-6">Tổng tiền phòng</dt>
                                <dd class="col-sm-6">@String.Format("{0:N0}", tongTienPhong)</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            @* Bảng dịch vụ *@
            <div class="table-responsive mb-3">
                <table class="table table-hover table-striped align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width:60px">STT</th>
                            <th>Tên dịch vụ</th>
                            <th class="text-end">Đơn giá</th>
                            <th class="text-center" style="width:120px">Số lượng</th>
                            <th class="text-end">Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int idx = 1;
                            decimal tongTienDichVu = 0m;
                            var dvList = order?.OrderPhongDichVus ?? Enumerable.Empty<dynamic>();
                            foreach (var dv in dvList)
                            {
                                decimal donGia = Convert.ToDecimal(dv.DonGia);
                                int soLuong = Convert.ToInt32(dv.SoLuong);
                                decimal thanh = donGia * soLuong;
                                tongTienDichVu += thanh;
                            }
                        }
                        @if (dvList == null || !dvList.Any())
                        {
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">Không có dịch vụ.</td>
                            </tr>
                        }
                        else
                        {
                            idx = 1;
                            foreach (var dv in dvList)
                            {
                                decimal donGia = Convert.ToDecimal(dv.DonGia);
                                int soLuong = Convert.ToInt32(dv.SoLuong);
                                decimal thanh = donGia * soLuong;
                                <tr>
                                    <td>@(idx++)</td>
                                    <td>@dv.MaDichVuNavigation?.TenDichVu</td>
                                    <td class="text-end">@String.Format("{0:N0}", donGia)</td>
                                    <td class="text-center">@soLuong</td>
                                    <td class="text-end">@String.Format("{0:N0}", thanh)</td>
                                </tr>
                            }
                        }

                        <tr>
                            <td colspan="4" class="fw-semibold text-end">Tổng tiền dịch vụ</td>
                            <td class="text-end">@String.Format("{0:N0}", Math.Floor(tongTienDichVu))</td>
                        </tr>

                        <tr>
                            <td colspan="4" class="fw-semibold text-end">Tổng tiền phòng</td>
                            <td class="text-end">@String.Format("{0:N0}", tongTienPhong)</td>
                        </tr>

                        @{
                            decimal tongTatCa = tongTienDichVu + tongTienPhong;
                        }
                        <tr class="table-success">
                            <td colspan="4" class="fw-bold text-end">Tổng cộng</td>
                            <td class="fw-bold text-end">@String.Format("{0:N0}", tongTatCa)</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-end mt-3">
                <button id="btnPrintFooter" class="btn btn-dark"><i class="bi bi-printer"></i> In hóa đơn</button>
            </div>
        </div>
    </div>
</div>

<!-- Print: chỉ in nội dung #invoiceCard -->
<script>
    function printElement(elemId) {
        const content = document.getElementById(elemId);
        if (!content) return;
        const original = document.body.innerHTML;
        const clone = content.cloneNode(true);

        // optional: remove buttons from clone
        clone.querySelectorAll('button, a.btn').forEach(n => n.remove());

        document.body.innerHTML = '';
        document.body.appendChild(clone);
        window.print();
        // restore
        document.body.innerHTML = original;
        location.reload(); // reload to re-bind scripts/styles (simpler)
    }

    document.getElementById('btnPrint')?.addEventListener('click', function () {
        printElement('invoiceCard');
    });
    document.getElementById('btnPrintFooter')?.addEventListener('click', function () {
        printElement('invoiceCard');
    });
</script>
